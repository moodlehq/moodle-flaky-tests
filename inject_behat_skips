#!/bin/bash

# This script injects a @skip tag into specified flaky scenarios in Moodle Behat test files.
# It reads a file containing flaky scenarios and their corresponding file paths,
# then modifies the test files to include the @skip tag above the specified scenarios.

# Ensure the script receives three parameters: branch, browser, and Moodle directory path/
if [[ $# -ne 3 ]]; then
    echo "Usage: $0 <branch> <browser> <path/to/moodle/root>"
    exit 1
fi

branch=$1
browser=$2
moodle_dir=$3

# Build the flaky scenarios file name.
FLAKY_SCENARIOS_FILE="$(dirname "$(realpath "$0")")/flaky_tests/${branch}_${browser}_flaky_tests.txt"
# Check if the file exists
if [[ ! -f "${FLAKY_SCENARIOS_FILE}" ]]; then
    echo "Warning: Flaky scenarios file not found at ${FLAKY_SCENARIOS_FILE}, skipping skip-tag injection."
    exit 0
fi

echo "Running inject_skip_tag script with ${FLAKY_SCENARIOS_FILE}"

# Process each line in the file.
while IFS='|' read -r scenario_name filepath; do
    # Skip empty lines or comments
    if [[ -z "${filepath}" || -z "${scenario_name}" || "${filepath}" =~ ^# ]]; then
        continue
    fi

    # Prepend the Moodle directory path to the filepath.
    full_filepath="${moodle_dir}/${filepath}"

    # Check if the test file exists.
    if [[ ! -f "${full_filepath}" ]]; then
        echo "Error: Test file not found at ${full_filepath}"
        continue
    fi

    escaped_scenario_name=$(printf '%s\n' "$scenario_name" | sed -e 's/[.[\*^$/]/\\&/g')

    # Inject the @skip tag above the scenario or scenario outline.
    if grep -q -E ":\s*${scenario_name}$" "${full_filepath}"; then
        awk -v scenario="$scenario_name" '
      {
        lines[++n] = $0
      }
      $0 ~ "^[[:space:]]*Scenario( Outline)?: " scenario "$" {
        sceneline = n
        tagline = n - 1

        # Extract indentation
        indent = gensub(/^([[:space:]]*).*/, "\\1", 1, lines[sceneline])

        if (tagline > 0) {
          if (lines[tagline] ~ /^[[:space:]]*@/) {
            if (lines[tagline] !~ /(^|[[:space:]])@skip([[:space:]]|$)/) {
              lines[tagline] = lines[tagline] " @skip"
            }
          } else {
            # Shift lines down
            for (i = n + 1; i > sceneline; i--) {
              lines[i] = lines[i - 1]
            }
            lines[sceneline] = indent "@skip"
            n++
          }
        }
      }
      END {
        for (i = 1; i <= n; i++) {
          print lines[i]
        }
      }
      ' "$full_filepath" > "$full_filepath.tmp" && mv "$full_filepath.tmp" "$full_filepath"
        echo "Injected @skip tag into ${full_filepath} for scenario: ${scenario_name}"
    else
        echo "Warning: Scenario '${scenario_name}' not found in ${full_filepath}"
    fi
done < "${FLAKY_SCENARIOS_FILE}"

echo "Behat skipper finished."
